<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD89CQpILmaxVdH-X7L-Ex4rW-XIBA3vHU",
            authDomain: "webai-b6629.firebaseapp.com",
            databaseURL: "https://webai-b6629-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "webai-b6629",
            storageBucket: "webai-b6629.appspot.com",
            messagingSenderId: "358930931757",
            appId: "1:358930931757:web:ed7b1ab7274bbdb3b7d8a4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.addEventListener("DOMContentLoaded", () => {
            const keyInput = document.getElementById("keyInput");
            const refreshBtn = document.getElementById("refreshBtn");
            const generateBtn = document.getElementById("generateBtn");
            const spinner = document.getElementById("timeSpinner");
            const validityText = document.getElementById("validityText");
            const keyList = document.getElementById("keyList");
            const validationText = document.getElementById("validationText");

            function generateRandomKey() {
                const chars = "abcdefghijklmnopqrstuvwxyz1234567890";
                let result = "";
                for (let i = 0; i < 7; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                keyInput.value = result;
                validationText.textContent = ""; // Reset validation message
            }

            refreshBtn.addEventListener("click", generateRandomKey);
            generateRandomKey(); // Set initial key

            spinner.addEventListener("change", () => {
                validityText.textContent = `Selected Validity: ${spinner.value}`;
            });

            generateBtn.addEventListener("click", () => {
                const key = keyInput.value.trim();
                const validity = spinner.value;
                if (key === "") return;

                // Check if key already exists in database
                onValue(ref(db, "keys"), (snapshot) => {
                    const keys = snapshot.val();
                    let keyExists = false;

                    if (keys) {
                        Object.values(keys).forEach((data) => {
                            if (data.key === key) {
                                keyExists = true;
                            }
                        });
                    }

                    if (keyExists) {
                        validationText.textContent = "Key already exists in Admin Panel";
                        validationText.classList.add("text-red-500", "text-lg", "font-bold");
                    } else {
                        const newKeyRef = push(ref(db, "keys"));
                        set(newKeyRef, {
                            key: key,
                            validUpto: validity,
                            deviceID: "NA",
                            createdBy: "Admin",
                            timestamp: Date.now()
                        });
                        generateRandomKey(); // Generate a new key
                    }
                }, { onlyOnce: true });
            });

            onValue(ref(db, "keys"), (snapshot) => {
                keyList.innerHTML = "";
                const keys = snapshot.val();
                if (keys) {
                    Object.entries(keys).reverse().forEach(([id, data]) => {
                        const keyItem = document.createElement("div");
                        keyItem.className = "fade-in bg-gray-900 text-green-400 p-4 rounded-lg shadow-lg mb-4 flex flex-col";
                        keyItem.innerHTML = `
                            <p><strong>User Key:</strong> ${data.key}</p>
                            <p><strong>Valid Upto:</strong> ${data.validUpto}</p>
                            <p><strong>Device ID:</strong> ${data.deviceID}</p>
                            <p class="text-xs text-gray-500">Key Generated By Admin</p>
                            <div class="mt-3 flex space-x-2">
                                <button class="bg-red-600 px-3 py-1 rounded text-white" onclick="deleteKey('${id}')">Delete</button>
                                <button class="bg-yellow-500 px-3 py-1 rounded text-black" onclick="resetKey('${id}')">Reset</button>
                                <button class="bg-blue-500 px-3 py-1 rounded text-white copy-btn" data-key="${data.key}">Copy</button>
                            </div>
                        `;
                        keyList.appendChild(keyItem);
                    });

                    document.querySelectorAll(".copy-btn").forEach(button => {
                        button.addEventListener("click", (event) => {
                            const key = event.target.getAttribute("data-key");

                            navigator.clipboard.writeText(key).then(() => {
                                event.target.textContent = "Copied";
                                event.target.classList.add("bg-green-500", "text-black");

                                setTimeout(() => {
                                    event.target.textContent = "Copy";
                                    event.target.classList.remove("bg-green-500", "text-black");
                                }, 2000);
                            });
                        });
                    });
                }
            });

            window.deleteKey = (keyId) => {
                remove(ref(db, "keys/" + keyId));
            };

            window.resetKey = (keyId) => {
                update(ref(db, "keys/" + keyId), { deviceID: "NA" });
            };
        });
    </script>

    <style>
        body {
            font-family: 'El Messiri', sans-serif;
            background-color: #0a0a0a;
            color: #00ff88;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            margin: auto;
        }
        input, select, button {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        input {
            background: #111;
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        button {
            cursor: pointer;
            font-weight: bold;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <h1 class="text-3xl font-bold">Welcome Admin</h1>

    <div class="container mt-6">
        <input type="text" id="keyInput" placeholder="Generated Key" readonly>
        <p id="validityText" class="text-green-300 text-sm mt-2">Selected Validity: 1 DAY</p>
        <p id="validationText" class="mt-2"></p>

        <div class="flex justify-between items-center mt-4">
            <button id="refreshBtn" class="bg-gray-700 text-white px-4 py-2">Refresh</button>
            <select id="timeSpinner" class="bg-black text-green-400 border border-green-400 ml-4">
                <option>1 DAY</option>
                <option>3 DAYS</option>
                <option>7 DAYS</option>
                <option>15 DAYS</option>
                <option>30 DAYS</option>
                <option>60 DAYS</option>
            </select>
        </div>

        <button id="generateBtn" class="bg-green-500 text-black mt-4">Generate Key</button>
    </div>

    <div id="keyList" class="mt-8"></div>
</body>
</html>